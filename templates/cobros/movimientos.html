{% extends "base.html" %}

{% block breadcrumb %}
Gestión de Cobros / Movimientos
{% endblock %}

{% block content %}

<div class="modal fade" id="modalPago" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Registrar Pago de Cuota</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="formPago">
                <div class="modal-body">
                    <input type="hidden" id="pago-cuota-id" name="cuota_id">
                    <div class="mb-3">
                        <label class="form-label">Fecha de Pago</label>
                        <input type="date" id="pago-fecha" name="fecha_pago" class="form-control" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Monto a Pagar (Gs.)</label>
                        <!-- CAMBIO AQUÍ: type="text" y class="input-money" -->
                        <input type="text" id="pago-monto" name="monto" class="form-control input-money fw-bold" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Forma de Pago</label>
                        <select id="selectFormaPago" name="forma_pago_id" class="form-select" required>
                            <option value="">Cargando...</option>
                        </select>
                    </div>
                    <div class="mb-3" id="div-cuenta-destino" style="display: none;">
                        <label class="form-label text-primary fw-bold">Cuenta Bancaria de Destino</label>
                        <select id="selectCuentaDestino" name="cuenta_bancaria_id" class="form-select">
                            <option value="">-- Seleccione Cuenta --</option>
                        </select>
                        <small class="text-muted">Seleccione dónde ingresará el dinero.</small>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Referencia (Opcional)</label>
                        <input type="text" name="referencia" class="form-control" placeholder="Ej: N° de transferencia, N° de cheque...">
                    </div>
                     <div class="mb-3">
                        <label class="form-label">Observaciones (Opcional)</label>
                        <textarea name="observaciones" class="form-control" rows="2"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Confirmar Pago</button>
                </div>
            </form>
        </div>
    </div>
</div>

<div class="modal fade" id="modalAbrirCaja" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Abrir Caja</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="formAbrirCaja">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="selectCaja" class="form-label">Seleccionar Caja</label>
                        <select class="form-select" id="selectCaja" required>
                            <option value="1">Caja General (ID 1)</option>
                            <option value="2">Caja Sucursal (ID 2)</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="montoApertura" class="form-label">Monto de Apertura (Gs.)</label>
                        <input type="number" class="form-control" id="montoApertura" value="0" min="0" required>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-success">Abrir Caja</button>
                </div>
            </form>
        </div>
    </div>
</div>

<div class="card mb-4 shadow-sm">
    <div class="card-body d-flex justify-content-between align-items-center">
        <div>
            <h4>Estado: <span id="estado-caja" class="badge bg-secondary">Cargando...</span></h4>
            <small>Solo se pueden registrar cobros en efectivo cuando la caja está abierta.</small>
        </div>
        <div>
            <button id="btn-abrir-caja" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#modalAbrirCaja" style="display: none;">Abrir Caja</button>
            <button id="btn-cerrar-caja" class="btn btn-danger" style="display: none;">Cerrar Caja</button>
        </div>
    </div>
</div>

<div id="alertaCajaCerrada" class="alert alert-danger text-center fw-bold shadow-sm" style="display: none;">
    <i class="fas fa-lock me-2"></i> LA CAJA ESTÁ CERRADA: NO SE PUEDEN PROCESAR COBROS
</div>

<div id="panel-cobros">
    <div class="card mb-4">
        <div class="card-header bg-light">
            <h3 class="card-title h5 mb-0">1. Buscar Cliente</h3>
        </div>
        <div class="card-body">
            <div class="form-group">
                <label for="buscador-cliente" class="form-label">Escribe el nombre o documento del cliente:</label>
                <div class="input-group">
                    <span class="input-group-text"><i class="fas fa-search"></i></span>
                    <input type="text" id="buscador-cliente" class="form-control" placeholder="Ej: Juan Pérez...">
                </div>
            </div>
            <div id="resultados-busqueda" class="list-group mt-2"></div>
        </div>
    </div>

    <div class="card" id="seccion-cuotas" style="transition: opacity 0.3s ease;">
        <div class="card-header bg-light">
            <h3 class="card-title h5 mb-0">2. Cuotas Pendientes de <span id="nombre-cliente-seleccionado" class="fw-bold text-primary">Nadie</span></h3>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-hover align-middle no-datatable" id="tablaCuotas">
                    <thead class="table-light">
                        <tr>
                            <th>Contrato</th>
                            <th>N° Cuota</th>
                            <th>Vencimiento</th>
                            <th>Monto</th>
                            <th>Estado</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="tbodyCuotas">
                        <tr>
                            <td colspan="6" class="text-center text-muted py-4">Selecciona un cliente para ver sus cuotas.</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
    <link rel="stylesheet" href="{{ url_for('static', filename='css/cobros.css') }}">
{% endblock %}

{% block extra_js %}
<script src="{{ url_for('static', filename='js/cobros.js') }}"></script>
{% endblock %}